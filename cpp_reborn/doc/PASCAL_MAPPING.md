# Pascal å®ç°æ˜ å°„ (C++ é‡æ„å‚è€ƒ)

æœ¬æ–‡æ¡£å°† C++ é‡æ„ä»»åŠ¡ (æ¥è‡ª `AI_TASK_PROMPTS.md`) æ˜ å°„åˆ° `kys-promise-main` ä¸­çš„åŸå§‹ Pascal å®ç°ã€‚è¯·ä»¥æ­¤ä½œä¸ºé€»è¾‘å¤åˆ»çš„â€œå”¯ä¸€çœŸå®æ¥æº (Source of Truth)â€ã€‚

**é¡¹ç›®åŸåˆ™**: é™¤éæ˜ç¡®éœ€è¦æ”¹è¿›ï¼Œå¦åˆ™é€»è¾‘å¿…é¡»ä¸¥æ ¼å¤åˆ» Pascal çš„è¡Œä¸ºã€‚

---

## ğŸ”´ ç¬¬ä¸€é˜¶æ®µ: æ ¸å¿ƒåŠŸèƒ½ (Phase 1: Core Features)

### C-00: ESC èœå• (è§†è§‰ä¿®å¤)
*   **ç›®æ ‡**: ä¿®å¤è´´å›¾åˆ‡ç‰‡å’ŒæŒ‰é’®é€»è¾‘ã€‚
*   **Pascal æ–‡ä»¶**: `kys_engine.pas`
*   **å…³é”®å‡½æ•°**: `NewMenuEsc` (ç¬¬ 5066 è¡Œ)
*   **è¾…åŠ©å‡½æ•°**: `showNewMenuEsc` (ç¬¬ 5305 è¡Œ)
*   **å®ç°ç»†èŠ‚**:
    *   ä½¿ç”¨ `Menuesc_PIC` (Index 6) å’Œ `MenuescBack_PIC` (Index 7)ã€‚
    *   **åˆ‡ç‰‡é€»è¾‘**:
        ```pascal
        // i = èœå•ç´¢å¼• (0..5)
        srcX := (i mod 3) * 100;
        srcY := (i div 3) * 100 + 200; // +200 æ„å‘³ç€ä½¿ç”¨ç¬¬ 2-3 è¡Œçš„â€œæœªé€‰ä¸­â€çŠ¶æ€
        // é€‰ä¸­çŠ¶æ€é€šå¸¸åœ¨ 0-1 è¡Œ (Y=0 æˆ– Y=100)
        ```
    *   **æŒ‰é’®å¸ƒå±€**: 6 ä¸ªæŒ‰é’®å‘ˆåœ†å½¢/å…­è¾¹å½¢æ’åˆ—ã€‚

### C-01: UI ç³»ç»Ÿè¡¥å…¨
*   **ç›®æ ‡**: ç‰©å“æ ã€ç³»ç»Ÿèœå•ã€å­˜è¯»æ¡£ã€å¼€åœºåŠ¨ç”»ã€‚
*   **Pascal æ–‡ä»¶**: `kys_engine.pas`, `kys_main.pas`
*   **å…³é”®å‡½æ•°**:
    *   **å¼€åœºåŠ¨ç”»**:
        *   `PlayBeginningMovie` (kys_engine.pas ç¬¬ 5575 è¡Œ): åŠ è½½ `Begin.Pic` (MOVIE_file) çš„æ¯ä¸€å¸§å¹¶å…¨å±æ˜¾ç¤ºã€‚
        *   **é€»è¾‘è¯´æ˜**: å¾ªç¯è¯»å–å¸§ï¼Œæ¯å¸§å»¶è¿Ÿ 20msï¼Œæ”¯æŒ ESC/Space/Enter è·³è¿‡ã€‚
        *   **ç§»æ¤å®ç°**: `UIManager::PlayTitleAnimation()`ã€‚åŠ¨ç”»ç»“æŸååŠ è½½ `Background.Pic` Index 1 ä½œä¸ºèƒŒæ™¯ã€‚
    *   **ç‰©å“æ **:
        *   `NewMenuItem` (ç¬¬ 5974 è¡Œ): ç‰©å“æ ä¸»å¾ªç¯ã€‚
        *   `showNewItemMenu` (ç¬¬ 6068 è¡Œ): æ¸²æŸ“é€»è¾‘ã€‚
        *   `SelectItemUser` (ç¬¬ 6099 è¡Œ): é€‰æ‹©ä½¿ç”¨ç‰©å“çš„è§’è‰²ã€‚
    *   **ç³»ç»Ÿèœå•**:
        *   `NewMenuSystem` (ç¬¬ 4360 è¡Œ): ä¸»å¾ªç¯ã€‚
        *   `NewShowMenuSystem` (ç¬¬ 4486 è¡Œ): æ¸²æŸ“é€»è¾‘ã€‚
    *   **å­˜è¯»æ¡£**:
        *   `NewMenuSave` (ç¬¬ 4532 è¡Œ)ã€‚
        *   `NewMenuLoad` (ç¬¬ 4622 è¡Œ)ã€‚
        *   **æ³¨æ„**: Pascal ä½¿ç”¨ `AssignFile`, `Rewrite`, `BlockWrite` è¿›è¡ŒäºŒè¿›åˆ¶åºåˆ—åŒ–ã€‚C++ å®ç°å¿…é¡»åŒ¹é… `R*.grp` æ–‡ä»¶çš„ç»“æ„å¸ƒå±€ã€‚

### C-02: æˆ˜æ–—äº¤äº’
*   **ç›®æ ‡**: ç©å®¶æ§åˆ¶ (ç§»åŠ¨ã€æ”»å‡»ã€æ­¦åŠŸã€ç‰©å“) å’Œ AIã€‚
*   **Pascal æ–‡ä»¶**: `kys_battle.pas`
*   **å…³é”®å‡½æ•°**:
    *   **æˆ˜æ–—èœå•**: `BattleMenu` (ç¬¬ 1142 è¡Œ)ã€‚
        *   ä½¿ç”¨ä½æ©ç  `menustatus` æ§åˆ¶æŒ‰é’®çš„å¯ç”¨æ€§ (ç§»åŠ¨ã€æ”»å‡»ã€æ­¦åŠŸã€ç‰©å“)ã€‚
    *   **ç§»åŠ¨é€»è¾‘**: `MoveRole` (ç¬¬ 1395 è¡Œ) & `CalMoveAbility` (ç¬¬ 1089 è¡Œ)ã€‚
    *   **æ”»å‡»é€»è¾‘**: `Attack` (ç¬¬ 2430 è¡Œ) & `AttackAction` (ç¬¬ 2601 è¡Œ)ã€‚
    *   **æ­¦åŠŸé€»è¾‘**: `SelectMagic` (ç¬¬ 2657 è¡Œ)ã€‚
    *   **AI é€»è¾‘**: `AutoBattle` (ç¬¬ 4508 è¡Œ) & `Auto` (ç¬¬ 6608 è¡Œ)ã€‚

### C-03: äº‹ä»¶ç³»ç»Ÿä¸æŒ‡ä»¤ (è¯¦ç»†æ˜ å°„)
*   **ç›®æ ‡**: è¡¥å…¨æŒ‡ä»¤é›†å¹¶ä¿®å¤äº‹ä»¶æµã€‚
*   **Pascal æ–‡ä»¶**:
    *   `kys_main.pas`: **è§£é‡Šå™¨å¾ªç¯** (çº¦ç¬¬ 4900 è¡Œ)ã€‚
    *   `kys_event.pas`: æŒ‡ä»¤å…·ä½“å®ç°ã€‚

#### âš ï¸ å…³é”®æŒ‡ä»¤å·®å¼‚ä¸é£é™©
*   **Instruct_23 (Opcode 23)**:
    *   **Pascal**: `procedure instruct_23(rnum, Poision: integer);`
    *   **åŠŸèƒ½**: è®¾ç½®è§’è‰²ä¸­æ¯’/ç”¨æ¯’å±æ€§ (`UsePoi`)ã€‚
    *   **å‚æ•°æ•°é‡**: 2 ä¸ª (rnum, Poison)ã€‚
    *   **æ³¨æ„**: ç»å¯¹ä¸æ˜¯åŠ¨ç”»æŒ‡ä»¤ã€‚å¦‚æœæŒ‰åŠ¨ç”»æŒ‡ä»¤è§£æ(4å‚æ•°)ä¼šå¯¼è‡´å‚æ•°é”™ä½ã€‚
*   **Instruct_27 (Opcode 27)**:
    *   **Pascal**: `procedure instruct_27(enum, beginpic, endpic: integer);`
    *   **åŠŸèƒ½**: æ’­æ”¾åŠ¨ç”»ã€‚

#### æŒ‡ä»¤è¡¨ (åŸºäº kys_main.pas è§£æ)
| Opcode | å‡½æ•°å | å‚æ•°æ•°é‡ (ä¸å«Op) | é€»è¾‘è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| 0 | `instruct_0` | 0 | ç©ºæŒ‡ä»¤/é‡ç”» |
| 1 | `instruct_1` | 3 | å¯¹è¯ (TalkNum, HeadNum, DisMode) |
| 2 | `instruct_2` | 2 | è·å¾—/å¤±å»ç‰©å“ (ItemNum, Amount) |
| 3 | `instruct_3` | 13 | ä¿®æ”¹åœºæ™¯/äº‹ä»¶ (æ•°ç»„å‚æ•°) |
| 4 | `instruct_4` | 3 | è¯¢é—®ä½¿ç”¨ç‰©å“ -> è·³è½¬ (Ret: Offset) |
| 5 | `instruct_5` | 2 | è¯¢é—®æˆ˜æ–— -> è·³è½¬ |
| 6 | `instruct_6` | 4 | æˆ˜æ–— (BattleNum, Jump1, Jump2, GetExp) |
| ... | ... | ... | ... |
| 19 | `instruct_19` | 2 | ç¬ç§» (X, Y) |
| 23 | `instruct_23` | 2 | **ä¸­æ¯’/ç”¨æ¯’** (Role, Poison) |
| 25 | `instruct_25` | 4 | ç§»åŠ¨é•œå¤´/è§’è‰²? (x1, y1, x2, y2) |
| 27 | `instruct_27` | 3 | **åŠ¨ç”»** (EventNum, BeginPic, EndPic) |
| 50 | `instruct_50` | 7 | **å¤æ‚é€»è¾‘** (Ret: JumpOffset æˆ– ä¿®æ”¹å˜é‡) |

**è§£é‡Šå™¨é€»è¾‘**:
Pascal ä½¿ç”¨ `case e[i] of` è·³è½¬ï¼Œæ¯ä¸ª case æ‰§è¡Œå®Œå `i := i + N`ï¼Œå…¶ä¸­ N = å‚æ•°æ•°é‡ + 1 (Opcodeæœ¬èº«)ã€‚
ä¾‹å¦‚ Opcode 1: `instruct_1(e[i+1], e[i+2], e[i+3]); i := i + 4;`
**æ³¨æ„**: `instruct_50` è¿”å›å€¼ `p` ä¼šå½±å“æŒ‡ä»¤æŒ‡é’ˆ `i` (è·³è½¬) æˆ–è€…ä¿®æ”¹å†…å­˜ `e` (å˜é‡èµ‹å€¼)ï¼Œè¿™æ˜¯å®ç°è„šæœ¬é€»è¾‘åˆ†æ”¯çš„å…³é”®ã€‚

### C-04: è§†è§‰ç‰¹æ•ˆ (VFX)
*   **ç›®æ ‡**: æ¸²æŸ“æ­¦åŠŸ/æ”»å‡»åŠ¨ç”»ã€å¤©æ°”ã€è‰²è°ƒã€‚
*   **Pascal æ–‡ä»¶**: `kys_gfx.pas`, `kys_battle.pas`
*   **å…³é”®å‡½æ•°**:
    *   **æ­¦åŠŸåŠ¨ç”»**: `PlayMagicAmination` (kys_battle.pas ç¬¬ 2892 è¡Œ)ã€‚
    *   **å›¾å½¢å˜æ¢**: `rotozoomSurfaceXY` (kys_gfx.pas) - ç”¨äºæ—‹è½¬ç¼©æ”¾ã€‚
    *   **å¤©æ°”**: `DrawClouds` (kys_gfx.pas) - äº‘å±‚/é›¨é›ªæ•ˆæœã€‚
    *   **è‰²è°ƒ**: `DrawCPic` (kys_gfx.pas) - æ”¯æŒ alpha æ··åˆå’Œé˜´å½±ã€‚

### C-05: ç‰©å“ä¸è£…å¤‡é€»è¾‘
*   **ç›®æ ‡**: å®ç°ç‰©å“ä½¿ç”¨æ•ˆæœå’Œè£…å¤‡å±æ€§åŠ æˆã€‚
*   **Pascal æ–‡ä»¶**: `kys_event.pas`, `kys_engine.pas`
*   **å…³é”®å‡½æ•°**:
    *   **ä½¿ç”¨ç‰©å“**: `instruct_32` (å¢åŠ ç‰©å“), `instruct_2` (æ˜¾ç¤ºè·å¾—ç‰©å“)ã€‚
    *   **è£…å¤‡å±æ€§**: `GetRoleAttack`, `GetRoleDefence` (kys_event.pas ç¬¬ 118 è¡Œèµ·) - è®¡ç®—è£…å¤‡åçš„æœ€ç»ˆå±æ€§ã€‚
    *   **å±æ€§è®¡ç®—**: å¿…é¡»åŒ…å« `Equip` å¸¦æ¥çš„åŠ æˆã€‚

---

## ğŸŸ¡ ç¬¬äºŒé˜¶æ®µ: æ¶æ„ä¼˜åŒ– (Phase 2: Architecture Optimization)

### O-01: è¾“å…¥ç³»ç»Ÿé‡æ„
*   **ç›®æ ‡**: é›†ä¸­è¾“å…¥å¤„ç† (ç§»é™¤ `SDL_PollEvent` å¾ªç¯)ã€‚
*   **Pascal æ–‡ä»¶**: `kys_engine.pas`
*   **å…³é”®å‡½æ•°**: `CheckBasicEvent` (ç¬¬ 7137 è¡Œ)ã€‚
*   **å½“å‰ Pascal æ¨¡å¼**: æ¯ä¸ªèœå•å‡½æ•° (`NewMenuEsc`, `BattleMenu`) éƒ½æœ‰è‡ªå·±çš„ `while (SDL_WaitEvent)` å¾ªç¯ã€‚C++ åº”è¿ç§»åˆ°åŸºäºå¸§çš„ `Update()` æ¨¡å‹ã€‚

### O-02: éŸ³é¢‘ç³»ç»Ÿ
*   **ç›®æ ‡**: ä» Windows MCI è¿ç§»åˆ° SDL_mixerã€‚
*   **Pascal æ–‡ä»¶**: `kys_engine.pas`
*   **å…³é”®å‡½æ•°**:
    *   `PlayMP3` (ç¬¬ 279 è¡Œ): å¤„ç†èƒŒæ™¯éŸ³ä¹ã€‚
    *   `PlaySound` (ç¬¬ 359 è¡Œ): å¤„ç†éŸ³æ•ˆ (SFX)ã€‚
