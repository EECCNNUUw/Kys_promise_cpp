# KYS C++ 重构工程开发汇总文档 (Development Document)

本文档汇总了项目的开发进度、历史记录、技术架构、踩坑经验（Pitfalls）、待办事项（TODO）以及下一步开发建议。它是项目的**核心参考文档**。

## 1. 项目概览 (Project Overview)

本项目是对经典游戏《金庸群侠传》（KYS）的 C++ 重构，旨在：
*   **现代化**：使用 C++17 和 SDL3 替代原版 Pascal/Delphi。
*   **二进制兼容**：直接支持原版数据文件 (`.grp`, `.idx`, `.smp` 等)，无需转换。
*   **逻辑复刻**：核心算法（战斗、事件、伤害计算）严格对齐原版逻辑。

---

## 2. 开发进度与历史 (History & Progress)

### 2.1 早期阶段 (Phase 1-2)
*   **基础架构**：建立了 `GameManager`, `SceneManager`, `UIManager` 的单例架构。
*   **资源加载**：实现了 `FileLoader` 和 `PicLoader`，支持 RLE8 压缩格式的图片解压 (`.grp`)。
*   **初步渲染**：实现了 Tile（地块）和 Sprite（精灵）的绘制。

### 2.2 近期攻坚 (Recent Updates - 2026/01/23)
*   **黑屏修复**：解决了游戏启动黑屏问题，原因是 `GameManager` 未初始化 `SceneManager` 导致资源未加载。
*   **场景/大地图分离**：
    *   重构了渲染逻辑，明确区分 **场景地图 (Scene 0-N)** 和 **大地图 (Scene -1)**。
    *   实现了 `DrawWorldMap`，支持 `wmp`/`wdx` 资源和大地图 (`EARTH.002`) 的渲染。
*   **新游戏流程修复**：
    *   修复了 `ranger.grp` 头部信息误导初始坐标的问题（原版 Header 指向大地图，但新游戏应始于 Scene 0）。
    *   强制修正 `InitNewGame` 为 Scene 0 (19, 20)，成功进入“小虾米居”并触发 Event 101 开场剧情。
*   **资源路径修复**：
    *   修正了 `FileLoader` 强制添加 `resource/` 前缀导致无法读取 `save/` 目录下文件 (`alldef.grp`, `allsin.grp`) 的 Bug。

---

## 3. 踩坑记录 (Pitfalls & Traps) - **重要！**

在开发过程中遇到的关键问题及解决方案，后续开发**务必注意**：

### 3.1 场景 ID 与初始坐标陷阱
*   **问题**：读取 `ranger.grp` (通常作为新游戏模板) 的头部数据时，它记录的 `SceneID` 是 `-1` (大地图)，坐标是 `(409, 217)`。如果直接使用这个数据初始化新游戏，会导致主角出现在大地图的错误位置，或者用场景图块渲染大地图坐标，导致花屏/黑屏。
*   **真相**：新游戏**必须**强制指定初始场景为 `0` (圣堂/软体娃娃居)，坐标约为 `(19, 20)`。原版是通过硬编码或脚本触发的，不能完全依赖 `ranger.grp` 的 Header。
*   **解决**：在 `GameManager::InitNewGame` 中强制覆盖 `m_currentSceneId = 0`。

### 3.2 资源路径解析 (FileLoader)
*   **问题**：`FileLoader::loadFile` 会智能添加 `resource/` 前缀。但这导致读取 `save/` 目录下的 `alldef.grp` 等文件时路径错误（变成了 `resource/save/alldef.grp`）。
*   **解决**：在读取非资源目录文件时，使用绝对路径或相对路径跳过前缀逻辑。代码中已增加绝对路径转换逻辑。

### 3.3 场景与大地图的渲染差异
*   **问题**：`DrawScene` 曾试图用同一套逻辑渲染所有场景。但大地图使用 `wmp` (World Map Pic) 和 `EARTH.002`，而普通场景使用 `smp` (Scene Map Pic) 和 `allsin.grp`。混用会导致严重的索引越界和渲染错误。
*   **解决**：在 `SceneManager::DrawScene` 中增加判断：若 `SceneID == -1`，调用 `DrawWorldMap`；否则执行常规场景渲染。

### 3.4 链接器锁死 (LNK1168)
*   **问题**：在 Windows 上，如果 `kys_cpp.exe` 正在运行（即使是后台挂起），编译器无法写入新文件，报错 `LNK1168`。
*   **解决**：编译前必须运行 `taskkill /F /IM kys_cpp.exe` 确保进程终止。

### 3.5 贴图索引逻辑 (smp vs mmap)
*   **问题**：NPC 贴图显示错误。
*   **真相**：Pascal 原版逻辑中，事件贴图索引 `> 0` 引用 `smp` (静态物体)，`< 0` 引用 `mmap` (角色)。且索引值通常需要 `div 2`。
*   **解决**：已在 `DrawScene` 中实现了该分流逻辑。

---

## 4. 待办事项 (TODO List)

### 4.1 优先级高 (High Priority)
- [ ] **输入优化**：对话框的输入响应过于灵敏（“连击”问题），需要增加按键释放检测或更严格的消抖。
- [ ] **大地图交互**：目前大地图仅实现了渲染，尚未实现碰撞检测（`CanWalk` 需适配大地图数据）和进入场景的逻辑。
- [ ] **场景切换**：完善 `Instruct_ChangeScene` 等指令，确保从场景出到大地图、或从大地图进入场景的流程顺畅。

### 4.2 核心系统补全
- [ ] **战斗系统集成**：`BattleManager` 已有骨架，但需与 `SceneManager` 对接（从事件触发战斗）。
- [ ] **物品系统 UI**：物品数据已加载，但物品栏、使用物品、装备系统的 UI 尚未实现。
- [ ] **存档/读档 UI**：底层 `loadData` 已实现，需要 UI 界面支持玩家选择存档位。

### 4.3 音频系统
- [ ] **SDL_mixer 集成**：目前音频模块为空，需要加载 `music/` 下的 MIDI/MP3 和 `sound/` 下的 WAV。

---

## 5. 未实现功能 (Unimplemented Features)

以下功能目前完全空白或仅有存根：
*   **小游戏**：打猎、钓鱼、奏乐、练字等小游戏逻辑。
*   **片头动画**：原版的动态片头（鹰飞过等）目前仅用静态图或简单动画替代。
*   **高级 AI**：战斗中的高级寻路和策略算法。
*   **动态天气/时间**：原版可能没有，但重构版预留了接口。

---

## 6. 下一步开发建议 (Next Steps)

1.  **稳固对话系统**：修复对话框的输入“手感”，确保剧情阅读体验流畅。这是 RPG 的核心。
2.  **打通大地图-场景循环**：实现“从场景出来进入大地图”以及“在大地图移动并进入其他场景”的完整闭环。这需要完善大地图的碰撞检测和坐标映射。
3.  **接入战斗**：选取一个简单的战斗（如打捕快），尝试从对话触发战斗，进入战斗场景，结算，然后返回大地图。这将验证整个游戏循环。

---
*文档更新日期：2026-01-23*
