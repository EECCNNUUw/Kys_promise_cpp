# KYS-Promise 重构项目待办事项清单 (TODO List)

本文档旨在梳理从 Pascal 到 C++ 重构过程中的剩余工作，按逻辑模块分类。

> **核心原则提醒**:
> 1. **二进制兼容性**: 保持 `GameObject` 及其子类与 DOS 原版数据结构 (`.grp`) 的内存布局一致。
> 2. **逻辑还原**: 优先确保游戏逻辑（公式、流程）与原版 `kys_*.pas` 代码一致。

---

## 1. 战斗系统完善 (Battle System)
> 目标：确保战斗流程完整、数值准确，并能与大地图无缝衔接。

- [ ] **数值公式验证 (Formulas)**
    - 对照 `kys_battle.pas`，严格验证伤害计算、治疗效果、命中率、暴击率等核心公式。
    - 确保 C++ 实现的运算结果与原版逻辑 1:1 一致。
- [ ] **战斗内物品使用 (Battle Item Usage)**
    - 实现战斗回合内的物品使用逻辑（如恢复生命/内力、解毒、使用暗器）。
    - 确保物品消耗与背包数据同步。
- [ ] **魔法特效渲染 (Magic Effects)**
    - 实现武功招式（Magic）攻击时的视觉动画效果。
    - 处理范围攻击（AOE）的覆盖区域渲染。
- [ ] **战斗流程集成 (Integration)**
    - 完善 `BattleManager` 与 `EventManager` 的接口。
    - 确保脚本指令能正确启动战斗，并根据战斗结果（胜利/失败）控制后续事件流。

## 2. UI 与交互界面 (User Interface)
> 目标：补全缺失的玩家交互界面，提升操作体验。

- [ ] **物品栏系统 (Inventory UI)**
    - 开发完整的物品清单界面，支持物品分类浏览。
    - 实现“使用”、“装备”、“查看详情”等交互功能。
- [ ] **系统菜单 (System Menu)**
    - 实现游戏内的系统菜单（ESC/功能键唤起）。
    - **重点**: 完成存档 (Save) 和读档 (Load) 的 UI 界面，支持选择存档槽位。
- [ ] **商店与交易 (Shop/Trade)**
    - 实现与 NPC 交易的界面，包括买入、卖出及金钱结算逻辑。
- [ ] **输入响应优化 (Input Handling)**
    - 重构输入处理机制，将阻塞式等待改为事件驱动，消除长时间动画或脚本执行时的“窗口假死”现象。

## 3. 事件系统增强 (Event System)
> 目标：支持所有原版脚本指令，确保剧情脚本正常运行。

- [ ] **高级指令补全 (Advanced Opcodes)**
    - 逐一排查并实现尚未移植的脚本指令（OpCode）。
    - 重点关注涉及小游戏、特殊变量操作或复杂流程控制的高编号指令。
- [ ] **动画指令支持 (Animation)**
    - 完善 `instruct_23` 等动画相关指令。
    - 确保精灵序列动画能按正确的帧率和位置播放，不阻塞主线程渲染。

## 4. 音频与底层优化 (Audio & Core)
> 目标：提升代码质量、跨平台能力及稳定性。

- [ ] **音频系统重构 (Audio System)**
    - 使用 `SDL_mixer` 库替换现有的 Windows `mciSendString` 接口。
    - 实现 BGM (MIDI/MP3/OGG) 的循环播放与音量控制。
    - 完善音效 (Sound Effects) 的加载与触发机制。
- [ ] **存档后端完善 (Save/Load Backend)**
    - 虽然文件加载器已就绪，需进一步验证 `R*.grp` (角色)、`S*.grp` (场景)、`D*.grp` (全局) 等数据序列化写回磁盘的正确性。
    - 确保存档文件能被原版 DOS 游戏读取（验证二进制兼容性）。
- [ ] **代码清理 (Code Cleanup)**
    - 修复编译过程中的警告（如 `size_t` 到 `int` 的截断警告）。
    - 提取并规范化代码中的“魔法数字”和硬编码坐标。
